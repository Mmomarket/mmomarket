<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMOMarket - Intermediações</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="/images/favicon.png">
</head>
<body>
    <script src="js/referral.js"></script>
    <header>
        <div class="headerheader">
            <h5>Published by MMOMarket</h5>
        </div>
        <div class="headercontainer">
            <div class="firstThird">
            <div class="logo">
                <a href="index.html"><img src="images/logo.png" alt="MMOMarket Logo"></a>
            </div>
            <div class="headercounter">
                <span>Mais de</span>
                <h3>200</h3>
                <span>Vendas realizadas</span>
            </div>
            <div class="divider">
                <img src="images/divider.png" alt="">
            </div>
            <div class="headercounter">
                <span>Mais de</span>
                <h3>50</h3>
                <span>Intermediações</span>
            </div>
            <div class="divider">
                <img src="images/divider.png" alt="">
            </div>
        </div>
            <nav>
                <ul>
                    <li><a href="index.html">Início</a></li>
                    <li><a href="listajogos.html">Comprar Moedas</a></li>
                    <li><a href="intermediar.html">Intermediações</a></li>
                </ul>
            </nav>

            <div class="buttoncontainer">
                <a href="https://discord.gg/TDBWAjvh"><button class="Discord">Discord</button></a>
            </div>
            <div class="cart-icon">
                <a href="carrinho.html" id="cart-link">
                    <img src="images/cart.png" alt="Carrinho">
                    <span class="cart-notification" id="cart-count">0</span>
                </a>
            </div>
        </div>
    </header>
    
    <nav>
        <ul>
            <li><a href="index.html">Início</a></li>
            <li><a href="listajogos.html">Comprar Moedas</a></li>
            <li><a href="intermediar.html">Intermediações</a></li>
        </ul>
    </nav>
    
    <main>
        <section class="intermediation-form">
            <h1>Solicitar Intermediação</h1>
            
            <form id="intermediation-form">
                <div class="form-group">
                    <label for="game">Selecione o jogo desejado:</label>
                    <select id="game" required>
                        <option value="">Escolha um jogo</option>
                        <option value="cabal">Cabal</option>
                        <option value="dofus">Dofus</option>
                        <option value="habbo">Habbo</option>
                        <option value="albion">Albion</option>
                        <option value="ragnarok">Ragnarok</option>
                        <option value="pristontale">Priston Tale</option>
                        <option value="throne">Throne and Liberty</option>
                        <option value="muonline">Mu Online</option>
                    </select>
                </div>
                
                <!-- Novo campo: Servidor -->
                <div class="form-group">
                    <label for="server">Servidor:</label>
                    <select id="server" required disabled>
                        <option value="">Primeiro selecione um jogo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="char-name">Nome do seu personagem:</label>
                    <input type="text" id="char-name" maxlength="30" required>
                </div>
                
                <div class="form-group">
                    <label for="other-char-name">Nome do personagem do outro jogador:</label>
                    <input type="text" id="other-char-name" maxlength="30" required>
                </div>
                
                <div class="form-group">
                    <label for="whatsapp">Seu whatsapp para contato:</label>
                    <input type="text" id="whatsapp" placeholder="(XX)XXXXX-XXXX" required>
                </div>
                
                <div class="form-group">
                    <label for="other-whatsapp">Whatsapp do outro jogador (se tiver):</label>
                    <input type="text" id="other-whatsapp" placeholder="(XX)XXXXX-XXXX">
                </div>
                
                <div class="form-group">
                    <label for="trade-description">Descreva a troca que será feita:</label>
                    <textarea id="trade-description" maxlength="200" required></textarea>
                </div>
                
                <div class="fee-notice">
                    <p>Para realizar a intermediação, cobramos uma taxa de 3% do comprador e mais 3% do vendedor.</p>
                </div>
                
                <div class="form-group checkbox">
                    <input type="checkbox" id="agreement" required>
                    <label for="agreement">Estou ciente e gostaria de prosseguir</label>
                </div>
                
                <button type="submit" class="primary-btn">Enviar pedido de intermediação</button>
            </form>
        </section>
        
        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Pedido Recebido!</h2>
                <p>Dentro das próximas horas, um intermediador entrará em contato com vocês in-game.</p>
                <p>Caso não consiga contato por lá, entrará em contato pelo(s) número(s) de Whatsapp fornecido(s).</p>
                <div class="success-icon">✓</div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>&copy; 2025 MMOMarket - Todos os direitos reservados</p>
    </footer>
    
    <script src="js/main.js"></script>
    <script src="js/carrinho.js"></script>
    // Substitua o script existente no final do arquivo intermediar.html
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('intermediation-form');
            const gameSelect = document.getElementById('game');
            const serverSelect = document.getElementById('server');
            const modal = document.getElementById('confirmation-modal');
            const closeBtn = modal.querySelector('.close');
            
            // Dados dos servidores por jogo
            const gameServers = {
                'cabal': ['BR - Mercurio', 'BR - Venus'],
                'dofus': ['Tal Kasha' , 'Draconiros' , 'Dakal' , 'Kourial' , 'Brial' , 'Salar' , 'Mikhal' , 'Rafal'],
                'habbo': ['BR'],
                'albion': ['Americas' , 'Asia' , 'Europe'],
                'ragnarok': ['bRO Thor', 'bRO Valhalla'],
                'pristontale': ['Cronus' , 'Awell' , 'Valento' , 'Migal' , 'Midranda' , 'Idhas'],
                'throne': ['WA - Moonstone' , 'WA - Invoker' , 'WA - Oblivion' , 'WA - Akidu' , 'EA - Carnage' , 'EA - Ivory' , 'EA - Snowburn' , 'EA - Stellarite' , 'EA - Adrenaline' , 'EA - Pippin' , 'SA - Starlight' , 'SA - Eldritch' , 'SA - Resistance' , 'SA - Chamir' , 'EU - Cascade' , 'EU - Emerald' , 'EU - Judgement' , 'EU - Destiny' , 'EU - Rebellion' , 'EU - Fortune' , 'EU - Talon' , 'EU - Arcane' , 'EU - Zephyr' , 'EU - Conviction' ,' EU - Obsidian' ,' EU - Paola'],
                'muonline' : ['Hellheim' , 'Alfheim' , 'Midgard' , 'Arcadia' , 'Fresei' , 'Nidavellir' , 'Ydalir']
            };
            
            // Atualizar servidores quando o jogo for alterado
            gameSelect.addEventListener('change', function() {
                const game = this.value;
                
                // Limpar opções de servidor atuais
                serverSelect.innerHTML = '';
                
                if (game) {
                    // Adicionar nova opção padrão
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Escolha um servidor';
                    serverSelect.appendChild(defaultOption);
                    
                    // Adicionar servidores específicos do jogo selecionado
                    gameServers[game].forEach(server => {
                        const option = document.createElement('option');
                        option.value = server;
                        option.textContent = server;
                        serverSelect.appendChild(option);
                    });
                    
                    // Habilitar o select de servidor
                    serverSelect.disabled = false;
                } else {
                    // Se nenhum jogo for selecionado, desabilitar o select de servidor
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Primeiro selecione um jogo';
                    serverSelect.appendChild(defaultOption);
                    serverSelect.disabled = true;
                }
            });
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Verificar se o servidor foi selecionado
                if (!serverSelect.value) {
                    alert('Por favor, selecione um servidor.');
                    return;
                }
                
                // Colete os dados do formulário
                const formData = {
                    game: document.getElementById('game').value,
                    server: document.getElementById('server').value,
                    character: document.getElementById('char-name').value,
                    otherCharacter: document.getElementById('other-char-name').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    otherWhatsapp: document.getElementById('other-whatsapp').value || 'Não fornecido',
                    tradeDescription: document.getElementById('trade-description').value
                };
                
                try {
                    // Definir a URL base do backend
                    const baseUrl = window.location.hostname === 'localhost' 
                        ? 'http://localhost:3000' 
                        : 'https://mmomarket-backend.onrender.com';
                    
                    // Enviar dados para o backend
                    const response = await fetch(`${baseUrl}/api/intermediation/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Exiba o modal de confirmação
                        modal.style.display = 'block';
                        
                        // Resetar o formulário
                        form.reset();
                        // Redefinir o select de servidor para o estado inicial
                        serverSelect.innerHTML = '<option value="">Primeiro selecione um jogo</option>';
                        serverSelect.disabled = true;
                    } else {
                        alert('Ocorreu um erro ao enviar seu pedido de intermediação. Por favor, tente novamente.');
                    }
                } catch (error) {
                    console.error('Erro ao enviar pedido:', error);
                    alert('Ocorreu um erro ao enviar seu pedido de intermediação. Por favor, tente novamente.');
                }
            });
            
            // Fechar o modal quando o usuário clicar no X
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            // Fechar o modal quando o usuário clicar fora dele
            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Validar formato do WhatsApp
            const whatsappInputs = document.querySelectorAll('#whatsapp, #other-whatsapp');
            whatsappInputs.forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length > 11) {
                        this.value = this.value.slice(0, 11);
                    }
                    
                    if (this.value.length > 0) {
                        let formatted = '';
                        if (this.value.length <= 2) {
                            formatted = `(${this.value}`;
                        } else if (this.value.length <= 7) {
                            formatted = `(${this.value.slice(0, 2)})${this.value.slice(2)}`;
                        } else {
                            formatted = `(${this.value.slice(0, 2)})${this.value.slice(2, 7)}-${this.value.slice(7)}`;
                        }
                        this.value = formatted;
                    }
                });
            });
        });
    </script>
</body>
</html>